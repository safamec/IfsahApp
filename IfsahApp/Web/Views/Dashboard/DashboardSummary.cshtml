@using IfsahApp.Core.ViewModels
@model IEnumerable<DashboardSummaryViewModel>

@{
    Layout = "_Layout";
    ViewBag.Title = "Dashboard Summary";

    var monthsFull = Model.Select(m => m.Month).ToArray();

    var monthsShort = monthsFull.Select(m => {
        DateTime dt;
        if (DateTime.TryParse(m, out dt))
            return dt.ToString("MMM");
        return m;
    }).ToArray();
}

<style>
    .badge-box { display:flex; gap:1rem; margin-bottom:1.5rem; }
    .dash-badge { flex:1; background:#0056A3; color:white; padding:1rem; border-radius:8px;
                  text-align:center; font-size:1.2rem; font-weight:bold; }
    .dash-badge span { font-size:1.8rem; font-weight:700; display:block; margin-top:5px; }

    .chart-card { height:330px; padding:10px; }
    .chart-title { text-align:center; font-weight:bold; }
    .chart-canvas-wrap { width:100%; height:250px; }
    .chart-canvas-wrap canvas { width:100%!important; height:100%!important; }
</style>

<div class="container mb-5">

    <h2 class="text-center my-4 fw-bold text-dark">Dashboard Summary</h2>

    <!-- FILTER -->
    <form method="get" class="row g-3 mb-4">

        <!-- RANGE PICKER -->
        <div class="col-md-4">
            <label>Select Date Range</label>
            <input type="text" id="dateRange" class="form-control" placeholder="Pick Date Range" readonly />
        </div>

        <!-- HIDDEN REAL FILTER FIELDS -->
        <input type="hidden" name="fromDate" id="fromDate" />
        <input type="hidden" name="toDate" id="toDate" />

        <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-primary w-100">Apply</button>
        </div>

        <div class="col-md-2 d-flex align-items-end">
            <a href="@Url.Action("DashboardSummary")" class="btn btn-secondary w-100">Reset</a>
        </div>

        <div class="col-md-4 d-flex align-items-end justify-content-end">
            <a class="btn btn-success" href="@Url.Action("ExportSummaryToExcel", "Dashboard")">üì• Export Excel</a>
        </div>

    </form>

    <!-- BADGES -->
    @{
        int total = Model.Sum(m => m.NumberOfDisclosures);
        int completed = Model.Sum(m => m.Completed);
        int underReview = Model.Sum(m => m.UnderReview);
        int rejected = Model.Sum(m => m.Rejected);
    }

    <div class="badge-box">
        <div class="dash-badge">Total <span>@total</span></div>
        <div class="dash-badge">Completed <span>@completed</span></div>
        <div class="dash-badge">Under Review <span>@underReview</span></div>
        <div class="dash-badge">Rejected <span>@rejected</span></div>
    </div>

    <!-- CHARTS -->
    <div class="row g-3">
        <div class="col-md-4">
            <div class="card chart-card">
                <div class="chart-title">Evolution by Status</div>
                <div class="chart-canvas-wrap"><canvas id="pieChart"></canvas></div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card chart-card">
                <div class="chart-title">Trend</div>
                <div class="chart-canvas-wrap"><canvas id="lineChart"></canvas></div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card chart-card">
                <div class="chart-title">Monthly Comparison</div>
                <div class="chart-canvas-wrap"><canvas id="barChart"></canvas></div>
            </div>
        </div>
    </div>

    <!-- TABLE -->
    <div class="card mt-4">
        <div class="card-header">Details</div>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Date</th><th>Total</th><th>New</th><th>Review</th>
                        <th>Exam</th><th>Completed</th><th>Rejected</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach(var row in Model)
                    {
                        <tr>
                            <td>@row.Month</td>
                            <td>@row.NumberOfDisclosures</td>
                            <td>@row.NewRequests</td>
                            <td>@row.UnderReview</td>
                            <td>@row.UnderExamination</td>
                            <td>@row.Completed</td>
                            <td>@row.Rejected</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>

<script>
    // Chart DATA
    const months = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(monthsShort));
    const total = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(m => m.NumberOfDisclosures)));
    const newReq = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(m => m.NewRequests)));
    const review = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(m => m.UnderReview)));
    const exam = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(m => m.UnderExamination)));
    const completed = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(m => m.Completed)));
    const rejected = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(m => m.Rejected)));

    // 1Ô∏è‚É£ RANGE PICKER
    const picker = new Litepicker({
        element: document.getElementById('dateRange'),
        singleMode: false,
        lang: 'ar',
        format: 'YYYY-MM-DD',
        numberOfMonths: 2,
        numberOfColumns: 2,
        setup: (picker) => {
            picker.on('selected', (start, end) => {
                document.getElementById('fromDate').value = start.format('YYYY-MM-DD');
                document.getElementById('toDate').value = end.format('YYYY-MM-DD');
            });
        }
    });

    // 2Ô∏è‚É£ PIE
    new Chart(pieChart, {
        type:"pie",
        data:{
            labels:["New","Review","Exam","Completed","Rejected"],
            datasets:[{
                data:[
                    newReq.reduce((a,b)=>a+b,0),
                    review.reduce((a,b)=>a+b,0),
                    exam.reduce((a,b)=>a+b,0),
                    completed.reduce((a,b)=>a+b,0),
                    rejected.reduce((a,b)=>a+b,0)
                ],
                backgroundColor:["#0056A3","#7EB6FF","#FFBFA5","#A8E6CF","#CBA1FF"]
            }]
        }
    });

    // 3Ô∏è‚É£ LINE
    new Chart(lineChart, {
        type:"line",
        data:{
            labels:months,
            datasets:[
                {label:"New", data:newReq, borderColor:"#0056A3"},
                {label:"Review", data:review, borderColor:"#7EB6FF"},
                {label:"Exam", data:exam, borderColor:"#FFBFA5"},
                {label:"Completed", data:completed, borderColor:"#A8E6CF"},
                {label:"Rejected", data:rejected, borderColor:"#CBA1FF"}
            ]
        }
    });

    // 4Ô∏è‚É£ BAR
    new Chart(barChart, {
        type:"bar",
        data:{
            labels:months,
            datasets:[
                {label:"Total", data:total, backgroundColor:"#0056A3"},
                {label:"New", data:newReq, backgroundColor:"#7EB6FF"},
                {label:"Review", data:review, backgroundColor:"#FFBFA5"},
                {label:"Exam", data:exam, backgroundColor:"#A8E6CF"},
                {label:"Completed", data:completed, backgroundColor:"#CBA1FF"},
                {label:"Rejected", data:rejected, backgroundColor:"#999"}
            ]
        }
    });
</script>
}
