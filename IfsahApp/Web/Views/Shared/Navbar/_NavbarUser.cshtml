@* Views/Shared/Navbar/_NavbarUser.cshtml *@
@using System.Security.Claims
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery

@{
    // إخفاء الجرس في كل صفحات /Disclosure/...
    var hideBell   = Context.Request.Path.StartsWithSegments("/Disclosure", StringComparison.OrdinalIgnoreCase);
    var tokens     = Antiforgery.GetAndStoreTokens(Context);
    var currentUrl = Context.Request.Path + Context.Request.QueryString;

    // الحالة + الاسم من الـClaims (مطابق لما تضعيه في AccountController)
    bool isAuth = User?.Identity?.IsAuthenticated ?? false;

    string? displayName =
        User?.FindFirst(ClaimTypes.GivenName)?.Value ??
        User?.FindFirst(ClaimTypes.Name)?.Value ??
        User?.Identity?.Name;

    if (!string.IsNullOrWhiteSpace(displayName) && displayName!.Contains("@"))
        displayName = displayName.Split('@')[0];

    displayName ??= Localizer["user"].Value;

    string? dept = User?.FindFirst("Department")?.Value; // الانتباه لحرف D الكبير
}

<ul class="navbar-nav">

    @if (isAuth)
    {
        <li class="nav-item dropdown" id="user-nav">
            <a class="nav-link dropdown-toggle d-flex align-items-center gap-2" href="#"
               role="button" data-bs-toggle="dropdown" aria-expanded="false" title="@displayName">
                <span class="avatar-initials">
                    @((displayName?.Length ?? 0) > 0 ? displayName![0] : 'U')
                </span>
                <span class="d-none d-md-inline">@displayName</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
                @if (!string.IsNullOrWhiteSpace(dept))
                {
                    <li>
                        <div class="dropdown-item text-muted small">
                            <i class="bi bi-building me-2"></i>@dept
                        </div>
                    </li>
                    <li><hr class="dropdown-divider" /></li>
                }
                <li>
                    <a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>@Localizer["profile"]</a>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                    <form method="post" action="/Account/Logout" class="px-2 m-0">
                        @Html.AntiForgeryToken()
                        <button class="dropdown-item" type="submit">
                            <i class="bi bi-box-arrow-right me-2"></i>@Localizer["logout"]
                        </button>
                    </form>
                </li>
            </ul>
        </li>
    }
    else
    {
        <li class="nav-item">
            <a class="nav-link" href="/Account/Login">
                <i class="bi bi-box-arrow-in-right me-1"></i>@Localizer["login"]
            </a>
        </li>
    }

    <meta name="csrf-token" content="@tokens.RequestToken" />

    @if (!hideBell)
    {
        <div class="d-flex justify-content-end mb-3 position-relative align-items-center gap-2">
            <button id="notifBtn" type="button" class="btn-notify"
                    aria-label="@Localizer["Notifications"]" title="@Localizer["Notifications"]">
                <i class="bi bi-bell i-bell"></i>
                <span id="notifBadge" class="btn-notify__badge is-hidden">0</span>
            </button>

            <div id="notifPanel" class="card shadow position-absolute"
                 style="right:0; top:48px; width:340px; display:none; z-index:1080;
                        background:var(--notif-card-bg); border-color:var(--notif-card-border);">
                <div class="card-header d-flex justify-content-between align-items-center py-2"
                     style="background:var(--notif-card-bg); color:var(--notif-item-text);">
                    <strong>@Localizer["Notifications"]</strong>
                    <div class="d-flex gap-2">
                        <form method="post" action="/Notifications/MarkAllRead" class="m-0 p-0">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-sm btn-outline-secondary">@Localizer["MarkAll"]</button>
                        </form>
                        <a href="/Notifications" class="btn btn-sm btn-outline-primary">@Localizer["ViewAll"]</a>
                    </div>
                </div>

                <ul id="notifList" class="list-group list-group-flush"
                    style="max-height:320px; overflow:auto; background:var(--notif-item-bg); color:var(--notif-item-text);">
                    <li class="list-group-item text-muted small"
                        style="background:var(--notif-item-bg); color:var(--notif-muted);">
                        @Localizer["NoNotifications"]
                    </li>
                </ul>
            </div>
        </div>
    }

    <li class="nav-item p-2">
        <label class="toggle-theme">
            <input type="checkbox" id="theme-checkbox" />
            <span class="slider"></span>
        </label>
    </li>

    <li class="nav-item p-2">
        <div class="language-toggle">
            @if (System.Threading.Thread.CurrentThread.CurrentCulture.Name.StartsWith("ar"))
            {
                <a asp-controller="Culture" asp-action="SetLanguage" asp-route-culture="en"
                   asp-route-returnUrl="@currentUrl" class="btn toggle-lang active">عربي</a>
            }
            else
            {
                <a asp-controller="Culture" asp-action="SetLanguage" asp-route-culture="ar"
                   asp-route-returnUrl="@currentUrl" class="btn toggle-lang active">English</a>
            }
        </div>
    </li>
</ul>

<!-- بقية سكريبتات الجرس نفسها عندك -->
<style>
.avatar-initials{
  width:28px;height:28px;border-radius:50%;
  display:inline-grid;place-items:center;font-weight:700;
  background:var(--bs-primary);color:#fff;line-height:1;font-size:.8rem;
}
</style>
