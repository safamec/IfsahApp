@model IfsahApp.Core.Models.Disclosure
@using IfsahApp.Core.Models
@using System.Linq
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["DisclosureDetailsTitle"];
    var disclosers = ViewBag.Disclosers as IEnumerable<User> ?? Enumerable.Empty<User>();
}

<div class="container py-3">
  <div class="row">
    <div class="col-lg-10 mx-auto">
      <div class="card shadow-sm">
        <div class="card-body">

          <h2 class="h4 mb-3">
            @Model.DisclosureNumber -
            @(Model.DisclosureType?.DisplayName ?? Model.DisclosureType?.EnglishName ?? Localizer["NA"].Value)
          </h2>

          <p><strong>@Localizer["Description"]:</strong> @Model.Description</p>
          <p><strong>@Localizer["Location"]:</strong> @(Model.Location ?? "")</p>
          <p><strong>@Localizer["Status"]:</strong> @Model.Status</p>
          <p><strong>@Localizer["SubmittedAt"]:</strong> @Model.SubmittedAt.ToString("yyyy-MM-dd")</p>
          <p><strong>@Localizer["SubmittedBy"]:</strong> @(Model.SubmittedBy?.FullName ?? "—")</p>
          <p><strong>@Localizer["AssignedTo"]:</strong> @(Model.AssignedToUser?.FullName ?? Localizer["Unassigned"].Value)</p>

          <hr />

          @* NOTES (اختياري) *@
          @if (Model.Notes != null)
          {
              <h4>@Localizer["Notes"]</h4>
              if (Model.Notes.Any())
              {
                  <ul class="list-unstyled">
                      @foreach (var note in Model.Notes.OrderByDescending(n => n.CreatedAt))
                      {
                          <li class="mb-2">
                              <strong>@(note.Author?.FullName ?? "—")</strong>
                              <small class="text-muted">@note.CreatedAt.ToString("g")</small><br />
                              @note.Content
                          </li>
                      }
                  </ul>
              }
              else
              {
                  <p>@Localizer["NoNotesAvailable"]</p>
              }
              <hr />
          }

          <h4>@Localizer["Attachments"]</h4>
          @if (Model.Attachments?.Any() == true)
          {
              <ul>
                  @foreach (var att in Model.Attachments)
                  {
                      var href = !string.IsNullOrWhiteSpace(att.FullPath)
                          ? att.FullPath
                          : (Url.Action("Download", "Attachments", new { id = att.Id }) ?? "#");
                      var text = string.IsNullOrWhiteSpace(att.FileName)
                          ? Localizer["Attachment"].Value
                          : att.FileName;

                      <li>
                          <a href="@href" target="_blank" rel="noopener">@text</a>
                      </li>
                  }
              </ul>
          }
          else
          {
              <p>@Localizer["NoAttachments"]</p>
          }

          <hr />

          <h4>@Localizer["AdminCommentsAssignment"]</h4>
          @if (Model.Comments?.Any() == true)
          {
              <ul class="list-unstyled">
                  @foreach (var c in Model.Comments.OrderByDescending(x => x.CreatedAt))
                  {
                      <li class="mb-2">
                          <strong>@(c.Author?.FullName ?? "—")</strong>
                          <small class="text-muted">@c.CreatedAt.ToString("g")</small><br />
                          @c.Text
                      </li>
                  }
              </ul>
          }
          else
          {
              <p>@Localizer["NoCommentsYet"]</p>
          }

          <form asp-action="AddComment" asp-controller="Dashboard" method="post" class="mt-3">
              @Html.AntiForgeryToken()
              <input type="hidden" name="disclosureId" value="@Model.Id" />
              <div class="mb-3">
                  <label for="commentText" class="form-label">@Localizer["AddCommentLabel"]</label>
                  <textarea name="commentText" id="commentText" class="form-control" rows="3" placeholder="@Localizer["EnterCommentPlaceholder"]"></textarea>
              </div>
              <div class="mb-3">
                  <label for="assignToDiscloserId" class="form-label">@Localizer["AssignToDiscloserLabel"]</label>
                  <select name="assignToDiscloserId" id="assignToDiscloserId" class="form-select">
                      <option value="">@Localizer["SelectDiscloserOption"]</option>
                      @foreach (var d in disclosers)
                      {
                          <option value="@d.Id">@d.FullName (@d.ADUserName)</option>
                      }
                  </select>
              </div>
              <button type="submit" class="btn btn-primary">@Localizer["SubmitBtn"]</button>
          </form>

        </div><!-- /card-body -->
      </div><!-- /card -->
    </div>
  </div>
</div>
