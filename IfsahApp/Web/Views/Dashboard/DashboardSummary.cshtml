@using IfsahApp.Core.ViewModels
@model IEnumerable<DashboardSummaryViewModel>
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer

@{
    Layout = "_Layout";
    ViewBag.Title = Localizer["Title"];

    var monthsFull = Model.Select(m => m.Month).ToArray();

    var monthsShort = monthsFull.Select(m => {
        DateTime dt;
        if (DateTime.TryParse(m, out dt))
            return dt.ToString("MMM");
        return m;
    }).ToArray();
}

<style>
    .badge-box { display:flex; gap:1rem; margin-bottom:1.5rem; }
    .dash-badge { flex:1; background:#0056A3; color:white; padding:1rem; border-radius:8px;
                  text-align:center; font-size:1.2rem; font-weight:bold; }
    .dash-badge span { font-size:1.8rem; font-weight:700; display:block; margin-top:5px; }

    .chart-card { height:330px; padding:10px; }
    .chart-title { text-align:center; font-weight:bold; }
    .chart-canvas-wrap { width:100%; height:250px; }
    .chart-canvas-wrap canvas { width:100%!important; height:100%!important; }
</style>

<div class="container mb-5">

    <h2 class="text-center my-4 fw-bold text-dark">@Localizer["Title"]</h2>

    <!-- FILTER -->
    <form method="get" class="row g-3 mb-4">

        <!-- RANGE PICKER -->
        <div class="col-md-4">
            <label>@Localizer["SelectDateRange"]</label>
            <input type="text" id="dateRange" class="form-control" placeholder="@Localizer["PickDateRange"]" readonly />
        </div>

        <input type="hidden" name="fromDate" id="fromDate" />
        <input type="hidden" name="toDate" id="toDate" />

        <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-primary w-100">@Localizer["Apply"]</button>
        </div>

        <div class="col-md-2 d-flex align-items-end">
            <a href="@Url.Action("DashboardSummary")" class="btn btn-secondary w-100">@Localizer["Reset"]</a>
        </div>

        <div class="col-md-4 d-flex align-items-end justify-content-end">
            <a class="btn btn-success" href="@Url.Action("ExportSummaryToExcel", "Dashboard")">ðŸ“¥ @Localizer["ExportExcel"]</a>
        </div>

    </form>

    <!-- BADGES -->
    @{
        int total = Model.Sum(m => m.NumberOfDisclosures);
        int completed = Model.Sum(m => m.Completed);
        int underReview = Model.Sum(m => m.UnderReview);
        int rejected = Model.Sum(m => m.Rejected);
    }

    <div class="badge-box">
        <div class="dash-badge">@Localizer["Total"] <span>@total</span></div>
        <div class="dash-badge">@Localizer["Completed"] <span>@completed</span></div>
        <div class="dash-badge">@Localizer["UnderReview"] <span>@underReview</span></div>
        <div class="dash-badge">@Localizer["Rejected"] <span>@rejected</span></div>
    </div>

    <!-- CHARTS -->
    <div class="row g-3">
        <div class="col-md-4">
            <div class="card chart-card">
                <div class="chart-title">@Localizer["EvolutionByStatus"]</div>
                <div class="chart-canvas-wrap"><canvas id="pieChart"></canvas></div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card chart-card">
                <div class="chart-title">@Localizer["Trend"]</div>
                <div class="chart-canvas-wrap"><canvas id="lineChart"></canvas></div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card chart-card">
                <div class="chart-title">@Localizer["MonthlyComparison"]</div>
                <div class="chart-canvas-wrap"><canvas id="barChart"></canvas></div>
            </div>
        </div>
    </div>

    <!-- TABLE -->
    <div class="card mt-4">
        <div class="card-header">@Localizer["Details"]</div>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>@Localizer["Date"]</th>
                        <th>@Localizer["Total"]</th>
                        <th>@Localizer["New"]</th>
                        <th>@Localizer["Review"]</th>
                        <th>@Localizer["Exam"]</th>
                        <th>@Localizer["Completed"]</th>
                        <th>@Localizer["Rejected"]</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach(var row in Model)
                    {
                        <tr>
                            <td>@row.Month</td>
                            <td>@row.NumberOfDisclosures</td>
                            <td>@row.NewRequests</td>
                            <td>@row.UnderReview</td>
                            <td>@row.UnderExamination</td>
                            <td>@row.Completed</td>
                            <td>@row.Rejected</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>

<script>
    const months = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(monthsShort));
    const total = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(m => m.NumberOfDisclosures)));
    const newReq = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(m => m.NewRequests)));
    const review = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(m => m.UnderReview)));
    const exam = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(m => m.UnderExamination)));
    const completed = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(m => m.Completed)));
    const rejected = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(m => m.Rejected)));

    const picker = new Litepicker({
        element: document.getElementById('dateRange'),
        singleMode: false,
        lang: 'ar',
        format: 'YYYY-MM-DD',
        numberOfMonths: 2,
        numberOfColumns: 2,
        setup: (picker) => {
            picker.on('selected', (start, end) => {
                document.getElementById('fromDate').value = start.format('YYYY-MM-DD');
                document.getElementById('toDate').value = end.format('YYYY-MM-DD');
            });
        }
    });

    new Chart(pieChart, {
        type:"pie",
        data:{
            labels:[
                "@Localizer["New"]",
                "@Localizer["Review"]",
                "@Localizer["Exam"]",
                "@Localizer["Completed"]",
                "@Localizer["Rejected"]"
            ],
            datasets:[{
                data:[
                    newReq.reduce((a,b)=>a+b,0),
                    review.reduce((a,b)=>a+b,0),
                    exam.reduce((a,b)=>a+b,0),
                    completed.reduce((a,b)=>a+b,0),
                    rejected.reduce((a,b)=>a+b,0)
                ],
                backgroundColor:["#0056A3","#7EB6FF","#FFBFA5","#A8E6CF","#CBA1FF"]
            }]
        }
    });

    new Chart(lineChart, {
        type:"line",
        data:{
            labels:months,
            datasets:[
                {label:"@Localizer["New"]", data:newReq, borderColor:"#0056A3"},
                {label:"@Localizer["Review"]", data:review, borderColor:"#7EB6FF"},
                {label:"@Localizer["Exam"]", data:exam, borderColor:"#FFBFA5"},
                {label:"@Localizer["Completed"]", data:completed, borderColor:"#A8E6CF"},
                {label:"@Localizer["Rejected"]", data:rejected, borderColor:"#CBA1FF"}
            ]
        }
    });

    new Chart(barChart, {
        type:"bar",
        data:{
            labels:months,
            datasets:[
                {label:"@Localizer["Total"]", data:total, backgroundColor:"#0056A3"},
                {label:"@Localizer["New"]", data:newReq, backgroundColor:"#7EB6FF"},
                {label:"@Localizer["Review"]", data:review, backgroundColor:"#FFBFA5"},
                {label:"@Localizer["Exam"]", data:exam, backgroundColor:"#A8E6CF"},
                {label:"@Localizer["Completed"]", data:completed, backgroundColor:"#CBA1FF"},
                {label:"@Localizer["Rejected"]", data:rejected, backgroundColor:"#999"}
            ]
        }
    });
</script>
}
