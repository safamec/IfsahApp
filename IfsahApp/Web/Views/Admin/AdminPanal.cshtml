@using IfsahApp.Core.ViewModels
@using IfsahApp.Web.Controllers
@model IEnumerable<ExaminerRowVM>
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["UsersTitle"];
}

@* Sidebar section *@
@section AdminSidebar {
    @await Html.PartialAsync("_AdminSidebar")
}

@* (اختياري) ستايل *@
@section Styles {
    <link rel="stylesheet" href="~/css/admin.css" asp-append-version="true" />
}

@if (TempData["ok"] is not null) { <div class="alert alert-success">@TempData["ok"]</div> }
@if (TempData["err"] is not null){ <div class="alert alert-danger">@TempData["err"]</div> }

<div class="d-flex justify-content-between align-items-center mb-3">
  <h5 class="mb-0">@Localizer["UsersHeading"]</h5>
  <a asp-action="AddExaminer" class="btn btn-primary">@Localizer["AddExaminerLink"]</a>
</div>

<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>@Localizer["NameCol"]</th>
          <th>@Localizer["ADCol"]</th>
          <th>@Localizer["DepartmentCol"]</th>
          <th>@Localizer["EmailCol"]</th>
          <th>@Localizer["RoleCol"]</th>
          <th>@Localizer["TempCol"]</th>
          <th style="width:320px">@Localizer["ActionsCol"]</th>
        </tr>
      </thead>
      <tbody>
      @foreach (var x in Model)
      {
        <tr>
          <td>@x.FullName</td>
          <td>@x.ADUserName</td>
          <td>@x.Department</td>
          <td>@x.Email</td>
          <td><span class="badge bg-@(x.Role=="Admin"?"primary":"secondary")">@x.Role</span></td>
          <td>
            @if (x.HasActiveTempAdmin)
            { <span class="badge bg-success">@Localizer["ActiveBadge"]</span> }
            else { <span class="text-muted">—</span> }
          </td>
          <td>
            <div class="d-flex gap-1 flex-wrap">
              @if (x.Role != "Admin")
              {
                <form asp-action="PromoteToAdmin" method="post" class="d-inline">
                  @Html.AntiForgeryToken()
                  <input type="hidden" name="id" value="@x.Id" />
                  <button class="btn btn-sm btn-outline-primary">@Localizer["PromoteToAdmin"]</button>
                </form>
              }
              else
              {
                <form asp-action="DemoteToExaminer" method="post" class="d-inline">
                  @Html.AntiForgeryToken()
                  <input type="hidden" name="id" value="@x.Id" />
                  <button class="btn btn-sm btn-outline-warning">@Localizer["DemoteToExaminer"]</button>
                </form>
              }

              <!-- Temp Admin -->
              <button class="btn btn-sm btn-outline-success" data-bs-toggle="modal"
                      data-bs-target="#tempAdminModal" data-id="@x.Id" data-name="@x.FullName">
                @Localizer["TempAdminBtn"]
              </button>
            </div>
          </td>
        </tr>
      }
      </tbody>
    </table>
  </div>
</div>

<!-- Modal: Temp Admin -->
<div class="modal fade" id="tempAdminModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" asp-action="GrantTempAdmin">
        @Html.AntiForgeryToken()
        <div class="modal-header">
          <h6 class="modal-title">@Localizer["TempAdminModalTitle"]</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="@Localizer["CloseBtn"]"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="id" id="tempUserId" />
          <div class="mb-2"><strong id="tempUserName"></strong></div>
          <div class="mb-3">
            <label class="form-label">@Localizer["EndsAtLocalLabel"]</label>
            <input type="datetime-local" name="endLocal" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">@Localizer["ReasonOptionalLabel"]</label>
            <input name="reason" class="form-control" />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" type="submit">@Localizer["SaveBtn"]</button>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">@Localizer["CloseBtn"]</button>
        </div>
      </form>
    </div>
  </div>
</div>

@section Scripts{
<script>
const modal = document.getElementById('tempAdminModal');
modal?.addEventListener('show.bs.modal', e=>{
  const btn = e.relatedTarget;
  document.getElementById('tempUserId').value = btn.getAttribute('data-id');
  document.getElementById('tempUserName').innerText = btn.getAttribute('data-name');
});
</script>
}
