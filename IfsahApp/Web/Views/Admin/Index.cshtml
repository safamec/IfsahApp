@{
    ViewData["Title"] = "Admin Panel";
}

<div class="d-flex justify-content-center align-items-center vh-100">
    <div class="card shadow-lg p-4" style="max-width: 600px; width: 100%;">
        <h2 class="text-center mb-4">Admin Panel</h2>

        <!-- Search box -->
        <div class="mb-3 position-relative">
            <label for="userSearch" class="form-label">Search User</label>
            <input type="text" id="userSearch" class="form-control" placeholder="Type user name or AD username" autocomplete="off" />
            <ul id="searchResults" class="list-group position-absolute w-100" style="z-index:1000; max-height:200px; overflow-y:auto;"></ul>
        </div>

        <!-- User info -->
        <div id="userInfo" style="display:none;">
            <h4 class="mb-3">User Info</h4>
            <p><strong>Full Name:</strong> <span id="fullName"></span></p>
            <p><strong>AD User:</strong> <span id="adUser"></span></p>
            <p><strong>Email:</strong> <span id="email"></span></p>
            <p><strong>Department:</strong> <span id="department"></span></p>

            <div class="mb-3">
                <label for="roleSelect" class="form-label">Role</label>
                <select id="roleSelect" class="form-select">
                    <option value="Employee">Employee</option>
                    <option value="Discloser">Discloser</option>
                    <option value="Admin">Admin</option>
                </select>
            </div>

            <div class="mb-3" id="adminDateDiv" style="display:none;">
                <label for="adminUntil" class="form-label">Admin Expiration Date</label>
                <input type="date" id="adminUntil" class="form-control" />
            </div>

            <button id="sendEmailBtn" class="btn btn-primary w-100">Send Email Confirmation To Employee</button>

            <div id="confirmationMessage" class="mt-3 text-success text-center fw-bold" style="display:none;"></div>
        </div>
    </div>
</div>

@section Scripts{
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
let selectedUserId = null;

$('#userSearch').on('keyup', function(){
    const query = $(this).val();
    if(query.length < 1){
        $('#searchResults').empty();
        return;
    }

    $.getJSON('/Admin/SearchUsers', { query: query }, function(data){
        $('#searchResults').empty();
        data.forEach(function(user){
            let li = $('<li class="list-group-item list-group-item-action"></li>');
            li.text(user.FullName + ' (' + user.ADUserName + ')');
            li.data('user', user);
            li.on('click', function(){
                const u = $(this).data('user');
                selectedUserId = u.Id;
                $('#fullName').text(u.FullName);
                $('#adUser').text(u.ADUserName);
                $('#email').text(u.Email);
                $('#department').text(u.Department);
                $('#roleSelect').val(u.Role);

                if(u.Role === 'Admin'){
                    $('#adminDateDiv').show();
                    $('#adminUntil').val(u.AdminUntil);
                } else {
                    $('#adminDateDiv').hide();
                    $('#adminUntil').val('');
                }

                $('#userInfo').show();
                $('#searchResults').empty();
                $('#userSearch').val(u.FullName);
            });
            $('#searchResults').append(li);
        });
    });
});

$('#roleSelect').on('change', function(){
    if($(this).val() === 'Admin'){
        $('#adminDateDiv').show();
    } else {
        $('#adminDateDiv').hide();
        $('#adminUntil').val('');
    }
});

// Send email confirmation
$('#sendEmailBtn').on('click', function(){
    if(!selectedUserId){
        alert('Please select a user first.');
        return;
    }

    const role = $('#roleSelect').val();
    const adminUntil = $('#adminUntil').val();

    $.post('/Admin/SendRoleEmail', { userId: selectedUserId, role: role, adminUntil: adminUntil }, function(response){
        $('#confirmationMessage').text(response.message).show();
    });
});
</script>
}
